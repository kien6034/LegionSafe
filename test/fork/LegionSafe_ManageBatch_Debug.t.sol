// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

import "forge-std/Test.sol";
import "../../src/LegionSafe.sol";

/**
 * @title LegionSafe ManageBatch Debug Test
 * @notice Fork test for debugging manageBatch call on deployed contract
 * @dev Run with: forge test --match-contract LegionSafe_ManageBatch_Debug --fork-url $BSC_RPC -vvvv
 */
contract LegionSafe_ManageBatch_Debug is Test {
    // Deployed LegionSafe contract on BSC
    address constant LEGION_SAFE = 0x93cCa2986817657305e9f3f8b67807D4ff91ac23;

    // Tokens
    address constant USDT = 0x55d398326f99059fF775485246999027B3197955;
    address constant USDC = 0x8AC76a51cc950d9822D68b83fE1Ad97B32Cd580d;
    address constant LEGION_TOKEN = 0x55f4c8abA71A1e923edC303eb4fEfF14608cC226;

    // KyberSwap Router
    address constant KYBER_ROUTER = 0x31c2F6fcFf4F8759b3Bd5Bf0e1084A055615c768;

    // KyberSwap MetaAggregationRouterV2
    address constant KYBER_META_ROUTER = 0x6131B5fae19EA4f9D964eAc0408E4408b66337b5;

    LegionSafe safe;
    address owner;
    address operator;

    function setUp() public {
        console.log("Forking BSC network...");
        // fork bsc network and select it
        vm.createSelectFork("https://bsc-mainnet.infura.io/v3/16b05f69acba4716a8e31d5594c85ffe");
        console.log("Forked BSC network...");
        // Get contract instance
        safe = LegionSafe(payable(LEGION_SAFE));

        console.log("Getting owner and operator from contract...");

        // Get owner and operator from contract
        // owner = safe.owner();
        operator = safe.operator();

        console.log("Owner and operator found...");

        console.log("LegionSafe Address:", LEGION_SAFE);
        // console.log("Owner:", owner);
        console.log("Operator:", operator);

        // Check balances
        console.log("\n=== Initial Balances ===");
        console.log("USDT Balance:", IERC20(USDT).balanceOf(LEGION_SAFE));
        console.log("USDC Balance:", IERC20(USDC).balanceOf(LEGION_SAFE));
        console.log("LEGION Balance:", IERC20(LEGION_TOKEN).balanceOf(LEGION_SAFE));
        console.log("ETH Balance:", LEGION_SAFE.balance);
    }

    /**
     * @notice Test manageBatch call with the provided data
     */
    function test_manageBatch_debug() public {
        // Prepare the batch call arrays
        address[] memory targets = new address[](7);
        bytes[] memory data = new bytes[](7);
        uint256[] memory values = new uint256[](7);

        // Call 1: USDT approve to KyberSwap Router
        targets[0] = USDT;
        data[0] = hex"095ea7b300000000000000000000000031c2f6fcff4f8759b3bd5bf0e1084a055615c768000000000000000000000000ffffffffffffffffffffffffffffffffffffffff";
        values[0] = 0;

        // Call 2: KyberSwap Router swap (USDT related)
        targets[1] = KYBER_ROUTER;
        data[1] = hex"87517c4500000000000000000000000055d398326f99059ff775485246999027b319795500000000000000000000000055f4c8aba71a1e923edc303eb4feff14608cc226000000000000000000000000ffffffffffffffffffffffffffffffffffffffff0000000000000000000000000000000000000000000000000000ffffffffffff";
        values[1] = 0;

        // Call 3: USDC approve to KyberSwap Router
        targets[2] = USDC;
        data[2] = hex"095ea7b300000000000000000000000031c2f6fcff4f8759b3bd5bf0e1084a055615c768000000000000000000000000ffffffffffffffffffffffffffffffffffffffff";
        values[2] = 0;

        // Call 4: KyberSwap Router swap (USDC related)
        targets[3] = KYBER_ROUTER;
        data[3] = hex"87517c450000000000000000000000008ac76a51cc950d9822d68b83fe1ad97b32cd580d00000000000000000000000055f4c8aba71a1e923edc303eb4feff14608cc226000000000000000000000000ffffffffffffffffffffffffffffffffffffffff0000000000000000000000000000000000000000000000000000ffffffffffff";
        values[3] = 0;

        // Call 5: USDT approve to KyberSwap Meta Router (specific amount)
        targets[4] = USDT;
        data[4] = hex"095ea7b30000000000000000000000006131b5fae19ea4f9d964eac0408e4408b66337b50000000000000000000000000000000000000000000000000027c807f060cee3";
        values[4] = 0;

        // Call 6: KyberSwap Meta Router swap (large calldata)
        targets[5] = KYBER_META_ROUTER;
        data[5] = hex"e21fd0e9000000000000000000000000000000000000000000000000000000000000002000000000000000000000000063242a4ea82847b20e506b63b0e2e2eff0cc6cb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000005a000000000000000000000000000000000000000000000000000000000000007e000000000000000000000000000000000000000000000000000000000000004e000000000000000000027c807f060cee300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000041a2c763255dd7ab6ce9f2f6e9f21b327fb453c471b8d82b18bd5976e9651e11002b1b65c3922b2b9b0188106474ec40ad26a5bfb18db35c499c1361ad02aed6881c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003e000000000000000000000000093cca2986817657305e9f3f8b67807d4ff91ac230000000000000000000000000000000000000000000000000000000000000140000000000000000000000000000000000000000000000000000000000000018000000000000000000025cad4578f2af200000000000000000029c53b893272d600000000000000000027c807f060cee300000000000000000027bca7760663d7000000000000000000000000000000000000029aacd0dd0000000f42400000000000000000000000000000004f82e73edb06d29ff62c91ec8f5ff06571bdeb29000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000029e8d6080000000000000000000000000000000000000000000000000000000000000003c0000000000000000000000000000000000000000000000000000000000000000161f598cd000000000000000092934e8915576ff4684cad10ee82dfe788e9250c0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000055d398326f99059ff775485246999027b31979558000000000000000000000029b6bb02200000000000000000027c807f060cee30000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000027c807f060cee3f7f995d600000000000200015455c918e405a2831fbff8595c0aae35ee3db9d1000000000000000000000000000000000000000000000000000000000000008000000000000000000000000093cca2986817657305e9f3f8b67807d4ff91ac2300000000000000000000000000000000000000000000000000000000000000200000000000000000000000001e40450f8e21bb68490d7d91ab422888fb3d60f10000000000000000000000008ac76a51cc950d9822d68b83fe1ad97b32cd580d800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000055d398326f99059ff775485246999027b31979550000000000000000000000008ac76a51cc950d9822d68b83fe1ad97b32cd580d000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001e0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000093cca2986817657305e9f3f8b67807d4ff91ac230000000000000000000000000000000000000000000000000027c807f060cee3000000000000000000000000000000000000000000000000002789ca76b6ff7f0000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000000010000000000000000000000001e40450f8e21bb68490d7d91ab422888fb3d60f100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000027c807f060cee3000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000028d7b22536f75726365223a2273756d6d65722d64656669222c22416d6f756e74496e555344223a22302e303131323531373733393334333936343236222c22416d6f756e744f7574555344223a22302e303131313833303031343535393234363939222c22526566657272616c223a22222c22466c616773223a302c22416d6f756e744f7574223a223131313834393531353137343036313636222c2254696d657374616d70223a313736333731383834362c22526f7574654944223a2262306536643864392d626134322d343163622d383532392d6362626165613263636537323a37333963376563332d616436622d346663322d623139382d663566666662623132343238222c22496e74656772697479496e666f223a7b224b65794944223a2231222c225369676e6174757265223a224e367131713155755378465a666772494b63746776662f68453132304742305a43474f4e65764a723743325a496d344d6e344c396d6879556a70464467334a6f67587475384e73314f6b62453343534f4b5561375649756d56375a4d495a364b7561327561456a6b464138654a6f5a4a666246416374526849586633586d554538653543715432764c47456e4f396a586c6b5778416a4d6537702b6f466177454535326d667a324f357a5470466178594c7055766f365344554f5572614b34555650436b3053393534785668315663624e487a42394c3432654d796a784b65676749334b502f7373564347384d2f34336451414e4b59536361435337372b42654c76787747656147557a35447a72313341446d71482b6b726b674f364241747172454e4242594d6f62316b7753446e7446775a457561334c4e3264596d69626557445467584e2f38342b6c75574c30365952314d4f773d3d227d7d00000000000000000000000000000000000000";
        values[5] = 0;

        // Call 7: LEGION token claim or similar operation
        targets[6] = LEGION_TOKEN;
        data[6] = hex"dd46508f00000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000069203b6e0000000000000000000000000000000000000000000000000000000000000320000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000002020d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000001c000000000000000000000000055d398326f99059ff775485246999027b31979550000000000000000000000008ac76a51cc950d9822d68b83fe1ad97b32cd580d00000000000000000000000044428c6ce391915d51f963c0dd395cd0f95fdfd2000000000000000000000000a0ffb9c1ce1fe56963b0321b32e7a0302114058b000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000108c0fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff6fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff70000000000000000000000000000000000000000000000615b0a7eec73af86330000000000000000000000000000000000000000000000000117f67dfd68311c0000000000000000000000000000000000000000000000000027bca7760663d700000000000000000000000093cca2986817657305e9f3f8b67807d4ff91ac2300000000000000000000000000000000000000000000000000000000000001a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000055d398326f99059ff775485246999027b31979550000000000000000000000008ac76a51cc950d9822d68b83fe1ad97b32cd580d";
        values[6] = 0;

        console.log("\n=== Executing manageBatch ===");
        console.log("Number of calls:", targets.length);
        console.log("Gas limit: 400000");

        // Impersonate the operator to execute the call
        vm.startPrank(operator);

        // Execute with try-catch to see the error
        try safe.manageBatch{gas: 400000}(targets, data, values) returns (bytes[] memory results) {
            console.log("\n=== SUCCESS ===");
            console.log("Returned results:", results.length);
            
            // Check final balances
            console.log("\n=== Final Balances ===");
            console.log("USDT Balance:", IERC20(USDT).balanceOf(LEGION_SAFE));
            console.log("USDC Balance:", IERC20(USDC).balanceOf(LEGION_SAFE));
            console.log("LEGION Balance:", IERC20(LEGION_TOKEN).balanceOf(LEGION_SAFE));
            console.log("ETH Balance:", LEGION_SAFE.balance);
        } catch Error(string memory reason) {
            console.log("\n=== REVERT with Error ===");
            console.log("Reason:", reason);
            revert(reason);
        } catch Panic(uint256 code) {
            console.log("\n=== PANIC ===");
            console.log("Panic code:", code);
            revert("Panic");
        } catch (bytes memory lowLevelData) {
            console.log("\n=== REVERT with low-level data ===");
            console.logBytes(lowLevelData);
            
            // Try to decode as custom error
            if (lowLevelData.length >= 4) {
                bytes4 selector;
                assembly {
                    selector := mload(add(lowLevelData, 32))
                }
                console.log("Error selector:");
                console.logBytes4(selector);
                
                // Known error selectors
                if (selector == 0xa5fa8d2b) {
                    console.log("-> SpenderNotWhitelisted()");
                } else if (selector == 0x82b42900) {
                    console.log("-> Unauthorized()");
                } else if (selector == 0xd47e0481) {
                    console.log("-> CallNotAuthorized()");
                } else if (selector == 0x5ff9a827) {
                    console.log("-> CallFailed(bytes)");
                    // Try to extract the inner error
                    if (lowLevelData.length > 68) {
                        console.log("Inner call failed, extracting nested error...");
                        console.logBytes(lowLevelData);
                    }
                }
            }
            
            revert("Low-level revert");
        }

        vm.stopPrank();
    }

    /**
     * @notice Test with unlimited gas to see if gas is the issue
     */
    function test_manageBatch_unlimited_gas() public {
        // Prepare the batch call arrays (same as above)
        address[] memory targets = new address[](7);
        bytes[] memory data = new bytes[](7);
        uint256[] memory values = new uint256[](7);

        // Call 1: USDT approve to KyberSwap Router
        targets[0] = USDT;
        data[0] = hex"095ea7b300000000000000000000000031c2f6fcff4f8759b3bd5bf0e1084a055615c768000000000000000000000000ffffffffffffffffffffffffffffffffffffffff";
        values[0] = 0;

        // Call 2: KyberSwap Router swap (USDT related)
        targets[1] = KYBER_ROUTER;
        data[1] = hex"87517c4500000000000000000000000055d398326f99059ff775485246999027b319795500000000000000000000000055f4c8aba71a1e923edc303eb4feff14608cc226000000000000000000000000ffffffffffffffffffffffffffffffffffffffff0000000000000000000000000000000000000000000000000000ffffffffffff";
        values[1] = 0;

        // Call 3: USDC approve to KyberSwap Router
        targets[2] = USDC;
        data[2] = hex"095ea7b300000000000000000000000031c2f6fcff4f8759b3bd5bf0e1084a055615c768000000000000000000000000ffffffffffffffffffffffffffffffffffffffff";
        values[2] = 0;

        // Call 4: KyberSwap Router swap (USDC related)
        targets[3] = KYBER_ROUTER;
        data[3] = hex"87517c450000000000000000000000008ac76a51cc950d9822d68b83fe1ad97b32cd580d00000000000000000000000055f4c8aba71a1e923edc303eb4feff14608cc226000000000000000000000000ffffffffffffffffffffffffffffffffffffffff0000000000000000000000000000000000000000000000000000ffffffffffff";
        values[3] = 0;

        // Call 5: USDT approve to KyberSwap Meta Router (specific amount)
        targets[4] = USDT;
        data[4] = hex"095ea7b30000000000000000000000006131b5fae19ea4f9d964eac0408e4408b66337b50000000000000000000000000000000000000000000000000027c807f060cee3";
        values[4] = 0;

        // Call 6: KyberSwap Meta Router swap (large calldata)
        targets[5] = KYBER_META_ROUTER;
        data[5] = hex"e21fd0e9000000000000000000000000000000000000000000000000000000000000002000000000000000000000000063242a4ea82847b20e506b63b0e2e2eff0cc6cb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000005a000000000000000000000000000000000000000000000000000000000000007e000000000000000000000000000000000000000000000000000000000000004e000000000000000000027c807f060cee300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000041a2c763255dd7ab6ce9f2f6e9f21b327fb453c471b8d82b18bd5976e9651e11002b1b65c3922b2b9b0188106474ec40ad26a5bfb18db35c499c1361ad02aed6881c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003e000000000000000000000000093cca2986817657305e9f3f8b67807d4ff91ac230000000000000000000000000000000000000000000000000000000000000140000000000000000000000000000000000000000000000000000000000000018000000000000000000025cad4578f2af200000000000000000029c53b893272d600000000000000000027c807f060cee300000000000000000027bca7760663d7000000000000000000000000000000000000029aacd0dd0000000f42400000000000000000000000000000004f82e73edb06d29ff62c91ec8f5ff06571bdeb29000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000029e8d6080000000000000000000000000000000000000000000000000000000000000003c0000000000000000000000000000000000000000000000000000000000000000161f598cd000000000000000092934e8915576ff4684cad10ee82dfe788e9250c0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000055d398326f99059ff775485246999027b31979558000000000000000000000029b6bb02200000000000000000027c807f060cee30000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000027c807f060cee3f7f995d600000000000200015455c918e405a2831fbff8595c0aae35ee3db9d1000000000000000000000000000000000000000000000000000000000000008000000000000000000000000093cca2986817657305e9f3f8b67807d4ff91ac2300000000000000000000000000000000000000000000000000000000000000200000000000000000000000001e40450f8e21bb68490d7d91ab422888fb3d60f10000000000000000000000008ac76a51cc950d9822d68b83fe1ad97b32cd580d800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000055d398326f99059ff775485246999027b31979550000000000000000000000008ac76a51cc950d9822d68b83fe1ad97b32cd580d000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001e0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000093cca2986817657305e9f3f8b67807d4ff91ac230000000000000000000000000000000000000000000000000027c807f060cee3000000000000000000000000000000000000000000000000002789ca76b6ff7f0000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000000010000000000000000000000001e40450f8e21bb68490d7d91ab422888fb3d60f100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000027c807f060cee3000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000028d7b22536f75726365223a2273756d6d65722d64656669222c22416d6f756e74496e555344223a22302e303131323531373733393334333936343236222c22416d6f756e744f7574555344223a22302e303131313833303031343535393234363939222c22526566657272616c223a22222c22466c616773223a302c22416d6f756e744f7574223a223131313834393531353137343036313636222c2254696d657374616d70223a313736333731383834362c22526f7574654944223a2262306536643864392d626134322d343163622d383532392d6362626165613263636537323a37333963376563332d616436622d346663322d623139382d663566666662623132343238222c22496e74656772697479496e666f223a7b224b65794944223a2231222c225369676e6174757265223a224e367131713155755378465a666772494b63746776662f68453132304742305a43474f4e65764a723743325a496d344d6e344c396d6879556a70464467334a6f67587475384e73314f6b62453343534f4b5561375649756d56375a4d495a364b7561327561456a6b464138654a6f5a4a666246416374526849586633586d554538653543715432764c47456e4f396a586c6b5778416a4d6537702b6f466177454535326d667a324f357a5470466178594c7055766f365344554f5572614b34555650436b3053393534785668315663624e487a42394c3432654d796a784b65676749334b502f7373564347384d2f34336451414e4b59536361435337372b42654c76787747656147557a35447a72313341446d71482b6b726b674f364241747172454e4242594d6f62316b7753446e7446775a457561334c4e3264596d69626557445467584e2f38342b6c75574c30365952314d4f773d3d227d7d00000000000000000000000000000000000000";
        values[5] = 0;

        // Call 7: LEGION token claim or similar operation
        targets[6] = LEGION_TOKEN;
        data[6] = hex"dd46508f00000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000069203b6e0000000000000000000000000000000000000000000000000000000000000320000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000002020d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000001c000000000000000000000000055d398326f99059ff775485246999027b31979550000000000000000000000008ac76a51cc950d9822d68b83fe1ad97b32cd580d00000000000000000000000044428c6ce391915d51f963c0dd395cd0f95fdfd2000000000000000000000000a0ffb9c1ce1fe56963b0321b32e7a0302114058b000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000108c0fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff6fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff70000000000000000000000000000000000000000000000615b0a7eec73af86330000000000000000000000000000000000000000000000000117f67dfd68311c0000000000000000000000000000000000000000000000000027bca7760663d700000000000000000000000093cca2986817657305e9f3f8b67807d4ff91ac2300000000000000000000000000000000000000000000000000000000000001a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000055d398326f99059ff775485246999027b31979550000000000000000000000008ac76a51cc950d9822d68b83fe1ad97b32cd580d";
        values[6] = 0;

        console.log("\n=== Executing manageBatch with UNLIMITED GAS ===");
        console.log("Number of calls:", targets.length);

        // Impersonate the operator to execute the call
        vm.startPrank(operator);

        // Execute without gas limit
        safe.manageBatch(targets, data, values);

        console.log("\n=== SUCCESS with unlimited gas ===");
        
        // Check final balances
        console.log("\n=== Final Balances ===");
        console.log("USDT Balance:", IERC20(USDT).balanceOf(LEGION_SAFE));
        console.log("USDC Balance:", IERC20(USDC).balanceOf(LEGION_SAFE));
        console.log("LEGION Balance:", IERC20(LEGION_TOKEN).balanceOf(LEGION_SAFE));

        vm.stopPrank();
    }
}
